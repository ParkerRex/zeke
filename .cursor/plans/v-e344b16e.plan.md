<!-- e344b16e-c9f8-4ae1-bb32-dfa91a765298 7c928ffa-180e-4379-bef6-8cd809815808 -->
# Full VPS Deployment (Cloudflare DNS + Netcup VPS)

## Scope and defaults

- Scope: Bring up staging on `152.53.88.183`, validate health + OAuth, then cut prod over. 
- Defaults: deliver images via SSH (`docker save | ssh docker load`); Cloudflare records set to DNS only initially; enable proxy (orange cloud) after certs.
- Security: You posted a private SSH key publicly; rotate it immediately and only use the rotated key moving forward.

## 1) Cloudflare DNS — staging records

Create A records (TTL Auto, Proxy: DNS only) pointing to `152.53.88.183`:

- app-staging.zekehq.com → 152.53.88.183
- api-staging.zekehq.com → 152.53.88.183
- engine-staging.zekehq.com → 152.53.88.183

Verify propagation:

```bash
dig +short app-staging.zekehq.com
Dig +short api-staging.zekehq.com
Dig +short engine-staging.zekehq.com
```

## 2) Deliver release images to the VPS (SSH load)

Assumes local images tagged `zeke-*:staging` and `zeke-*:prod`. Load staging first:

```bash
# Dashboard
docker save zeke-dashboard:staging | ssh -i ~/.ssh/netcup-vps root@152.53.88.183 'docker load'
# Website
docker save zeke-website:staging   | ssh -i ~/.ssh/netcup-vps root@152.53.88.183 'docker load'
# API
docker save zeke-api:staging       | ssh -i ~/.ssh/netcup-vps root@152.53.88.183 'docker load'
# Engine
docker save zeke-engine:staging    | ssh -i ~/.ssh/netcup-vps root@152.53.88.183 'docker load'
```

Rotate the SSH key before using; store private key with `chmod 600`.

## 3) Sync deployment files to the VPS

Copy the `deploy/` directory to the VPS so Caddy and Compose configs are present:

```bash
rsync -avz --delete deploy/ root@152.53.88.183:/srv/zeke/deploy/
```

Fill `deploy/env/staging/*.env` with real secrets (Supabase, Google OAuth, Stripe, Resend, etc.).

## 4) Pin images in Compose (staging profile)

Edit `deploy/docker-compose.yml` to pin exact images and remove any `build:` blocks (example):

```yaml
services:
  dashboard:
    image: zeke-dashboard:staging
  website:
    image: zeke-website:staging
  api:
    image: zeke-api:staging
  engine:
    image: zeke-engine:staging
```

Ensure `deploy/proxy/Caddyfile` has staging site blocks for `app-staging`, `api-staging`, and `engine-staging` upstreaming to `dashboard`, `api`, and `engine` containers.

## 5) Bring up staging

On the VPS:

```bash
ssh -i ~/.ssh/netcup-vps root@152.53.88.183
cd /srv/zeke/deploy
# Optional sanity: docker compose config --profile staging --quiet
docker compose --profile staging up -d
watch docker compose ps
```

Caddy should obtain certs automatically once DNS resolves.

## 6) Staging smoke tests

```bash
curl -fsS https://api-staging.zekehq.com/health
curl -fsS https://engine-staging.zekehq.com/health
# quick page checks
curl -I https://app-staging.zekehq.com/
```

Expect HTTP 200 (or 204/OK for health endpoints). If certs are not ready, wait 1–2 minutes.

## 7) OAuth smoke on staging

- Confirm Supabase Auth redirect whitelists include `https://app-staging.zekehq.com/api/auth/callback`.
- Verify Google OAuth client has `app-staging.zekehq.com` origins/callbacks (see `docs/oauth-supabase-redirects.md`).
- Sign in on staging and confirm you land in the dashboard without a loop.

## 8) Enable Cloudflare proxy (optional, post-ACME)

- Flip the three staging records to Proxied (orange cloud).
- Set SSL/TLS mode to Full (strict).
- Re-test step 6.

## 9) Production DNS cutover

Add A records (TTL Auto; consider DNS only until first cert, then enable proxy):

- app.zekehq.com → 152.53.88.183
- api.zekehq.com → 152.53.88.183
- engine.zekehq.com → 152.53.88.183
- zekehq.com (apex) → 152.53.88.183
- www.zekehq.com → 152.53.88.183

Ensure `deploy/proxy/Caddyfile` includes production site blocks for the above hostnames.

## 10) Bring up production

Pin prod images in `deploy/docker-compose.yml` under the production profile, then:

```bash
cd /srv/zeke/deploy
# Load prod images if needed
# docker save zeke-*:prod | ssh ... 'docker load'
# Bring up
docker compose --profile production up -d
```

Run the same smoke tests against `app.zekehq.com`, `api.zekehq.com/health`, `engine.zekehq.com/health`.

## 11) Systemd auto-start

Create `/etc/systemd/system/zeke-staging.service` (example):

```ini
[Unit]
Description=Zeke Staging
After=network-online.target

[Service]
Type=oneshot
WorkingDirectory=/srv/zeke/deploy
ExecStart=/usr/bin/docker compose --profile staging up -d
ExecStop=/usr/bin/docker compose --profile staging down
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
systemctl daemon-reload
systemctl enable --now zeke-staging
```

Create a similar unit for production when ready.

## 12) Engine regression tests (Bun)

- Add Bun tests under `apps/engine` to exercise `/health`, `/ingest`, `/source` happy-paths.
- Wire `bun test` in CI to guard regressions post-refactor.

## 13) Ops docs and monitoring

- Finalize `deploy/README.md` with build/push/load, compose commands, smoke tests, and rollback steps.
- Configure log rotation for Caddy and Docker; document retrieval commands and recommended alert checks.

## Rollback

- Re-tag and load last-known-good images; `docker compose --profile <env> up -d`.
- For DNS incidents, flip records back or disable proxy while investigating.

### To-dos

- [ ] Create staging A records in Cloudflare (DNS only) to 152.53.88.183
- [ ] Transfer staging images to VPS via docker save|ssh docker load
- [ ] Rsync deploy/ to /srv/zeke/deploy on VPS
- [ ] Pin image tags in deploy/docker-compose.yml staging profile
- [ ] Start staging stack with docker compose profile
- [ ] Run staging health checks and basic page loads
- [ ] Verify Google OAuth flow works on staging
- [ ] Enable Cloudflare proxy and set SSL Full (strict)
- [ ] Create production A records in Cloudflare to 152.53.88.183
- [ ] Transfer prod images to VPS (or pull)
- [ ] Pin prod image tags in docker-compose production profile
- [ ] Start production stack and validate health
- [ ] Create systemd unit(s) to auto-start stacks
- [ ] Add Bun engine regression tests for key endpoints
- [ ] Write deploy/README with rollback and monitoring guidelines