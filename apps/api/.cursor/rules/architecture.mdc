---
description: Zeke API architecture and extension guidelines for REST + tRPC on Bun/Hono
globs:
  - apps/api/**
alwaysApply: true
---

## Midday API Architecture (Bun + Hono + zod-openapi + tRPC)

### High-level
- The API runs on Bun using Hono as the HTTP framework.
- REST endpoints are built with `OpenAPIHono` + `zod-openapi` and live in `src/rest/routers/*` with schemas in `src/schemas/*`.
- A tRPC surface is mounted at `/trpc/*` using `@hono/trpc-server`, with routers in `src/trpc/routers/*`.
- OpenAPI spec is served at `/openapi`, with a Scalar UI at `/`.

### Entrypoint and server
- Entry: `src/index.ts` creates an `OpenAPIHono<Context>()`, installs `secureHeaders()` and CORS, mounts tRPC and REST routers, and exposes health endpoints:
  - `/health` basic
  - `/health/pools` connection pool health (from `@midday/db/client`)
  - `/health/db` DB connectivity timings
- Server export: `export default { port, fetch, host: "::" }` so Bun uses `process.env.PORT` (Fly sets this to 8080).
- CORS: allowed origins come from `ALLOWED_API_ORIGINS` (comma-separated).

### Request lifecycle (REST)
- Route mounting: `src/rest/routers/index.ts`
  - Public routes: `/oauth` (mounted before protection)
  - Protected routes: all others go through `protectedMiddleware`
- `protectedMiddleware` chain (in order):
  1) `withDatabase` attaches a singleton DB client to `c.set("db", db)`
  2) `withAuth` authenticates:
     - OAuth access tokens start with `mid_access_token_`
     - API keys start with `mid_` and are verified via hashed lookup; user and key are cached
     - Sets `session`, `teamId`, and `scopes` (expanded via `expandScopes`)
  3) Rate limiting (`hono-rate-limiter`) keyed by `session.user.id`
  4) `withPrimaryReadAfterWrite` routes traffic to primary DB for mutations and for recent reads after writes (per-team window via cache)
- Authorization per-endpoint: `withRequiredScope("resource.action")` (e.g., `invoices.read`, `invoices.write`).
- Inside handlers, use:
  - `const db = c.get("db")`
  - `const teamId = c.get("teamId")`
  - `const session = c.get("session")`
  - `c.req.valid("query" | "json" | "param")` to consume validated inputs
  - `validateResponse(data, schema)` to enforce response types

### Directory layout (API)
- `src/rest/routers/*`: One file per resource (e.g., `invoices.ts`, `transactions.ts`). Each uses `app.openapi(createRoute(...), handler)`.
- `src/schemas/*`: All request/response schemas as `zod-openapi` objects. Re-used by REST endpoints.
- `src/rest/middleware/*`: Database, auth, scope, and replication-aware routing.
- `src/trpc/*`: tRPC context, middleware, and routers.
- `src/services/*`: Service clients (e.g., Resend, Supabase).
- `src/utils/*`: Auth/session types, health checks, scopes, search helpers, etc.

### REST endpoint pattern
- Define or reuse schemas in `src/schemas/*`.
- In a router file:
  - Create `const app = new OpenAPIHono<Context>()`.
  - Use `app.openapi(createRoute({ method, path, request, responses, middleware: [withRequiredScope(...)] }), async (c) => { ... })`.
  - Fetch inputs using `c.req.valid(...)`, get `db`, `teamId`, `session` from context, call `@midday/db/queries`, then `return c.json(validateResponse(result, ResponseSchema))`.
- Mount the router in `src/rest/routers/index.ts` under a path segment (e.g., `routers.route("/invoices", invoicesRouter)`).

### tRPC surface
- Mounted at `/trpc/*` in `src/index.ts` with `appRouter` from `src/trpc/routers/_app.ts`.
- Context (`createTRPCContext`) provides `{ session, supabase, db, geo, teamId }`.
- Prefer REST for OpenAPI exposure and external SDKs; use tRPC for internal Dashboard/clients needing types end-to-end.

### AuthN & AuthZ details
- Bearer scheme only. Two token types:
  - OAuth access tokens (`mid_access_token_...`): validated via `validateAccessToken`, attach `session`, `teamId`, and optional `oauth` app context.
  - API keys (`mid_...`): validated via hashed lookup (`@midday/db/queries`), with caching (`@midday/cache`).
- Scopes:
  - Expand using `expandScopes` (presets support).
  - Enforce with `withRequiredScope("<resource>.<read|write>")` at route level.

### Database and replication
- DB client: `@midday/db/client` (Drizzle) with optional primary-only mode via `db.usePrimaryOnly?.()`.
- Queries: `@midday/db/queries` (typed functions; pass `{ teamId, ... }`).
- Replication awareness:
  - Mutations always use primary and mark a short-living per-team flag.
  - Queries check the flag; if set, route to primary to avoid replica lag.

### Storage & pre-signed URLs
- For documents/inbox/transaction attachments:
  - Use `createAdminClient()` (Supabase) and `signedUrl` from `@midday/supabase/storage`.
  - Bucket: `vault`; default expiry: 60s; supports optional `download` flag.

### Health, security, and CORS
- Health endpoints documented above.
- `secureHeaders()` enabled globally.
- CORS origins from `ALLOWED_API_ORIGINS` (CSV). Standard method/header set including `x-trpc-source` and user locale headers.

### Deployment & runtime
- Dockerfile (`apps/api/Dockerfile`): Bun base, installs Turbo, `turbo prune @midday/api --docker`, `bun install`, copies pruned sources, copies `apps/engine/dist` (prebuilt by CI), and runs `bun run src/index.ts`.
- Ports: container exposes 3000, Fly sets `PORT=8080` and `internal_port=8080` (`fly.toml` / `fly-preview.yml`). The server honors `process.env.PORT`.
- Fly scaling/resources differ between `fly.toml` (prod) and `fly-preview.yml` (staging).

### Add a new REST endpoint (checklist)
- Schema: add/extend in `src/schemas/*`.
- Router: create `src/rest/routers/<resource>.ts` using `OpenAPIHono` + `createRoute` + `withRequiredScope`.
- Use context: `db`, `teamId`, `session` from `c.get(...)`. Parse input with `c.req.valid(...)`.
- Call `@midday/db/queries` and validate responses with `validateResponse`.
- Mount in `src/rest/routers/index.ts`.
- If files are involved, generate signed URLs via Supabase as in `documents.ts`/`inbox.ts`/`transactions.ts`.

### Add a new tRPC procedure (checklist)
- Add to `src/trpc/routers/*` and export via `_app.ts`.
- Use `ctx.db`, `ctx.teamId`, `ctx.session`, and optional replication-aware middleware.
- Keep inputs/outputs strongly typed; prefer reusing schema shapes when possible.

### Common gotchas
- Always gate protected routes with `withRequiredScope`; donâ€™t rely on implicit access.
- Use `validateResponse` before returning JSON to keep REST types in sync.
- Prefer `c.req.valid(...)` over manual parsing to leverage `zod-openapi` validation.
- For post-write reads that must be fresh, rely on the default replication middleware; do not manually swap DB connections.
- Ensure CORS origins are configured via `ALLOWED_API_ORIGINS` in each environment.

### Key files to know
- Server: `src/index.ts`
- Router mount: `src/rest/routers/index.ts`
- Middleware: `src/rest/middleware/*` (`auth`, `db`, `primary-read-after-write`, `scope`)
- Schemas: `src/schemas/*`
- tRPC: `src/trpc/*`
- Deployment: `apps/api/Dockerfile`, `apps/api/fly.toml`, `apps/api/fly-preview.yml`

