---
description: Midday API architecture and schema patterns for Hono + Zod OpenAPI + tRPC
globs:
alwaysApply: true
---

### What this rule covers
- Core stack and entrypoint
- REST routing and middleware flow
- Zod schema conventions and validation
- Auth, scopes and session context
- Primary-read-after-write pattern
- TRPC context for internal clients
- Health, deployment and ops notes
- How to add a new endpoint

### Core stack
- Hono with @hono/zod-openapi for REST and OpenAPI generation.
- tRPC mounted at `/trpc/*` for internal clients.
- Drizzle-based DB client via `@midday/db`.
- Bun runtime.

### Entrypoint
- `apps/api/src/index.ts` sets security headers, CORS, mounts tRPC and OpenAPI docs, registers health endpoints, and routes under `/`.
- CORS origins come from `ALLOWED_API_ORIGINS` env.

### REST routing
- Routers live in `apps/api/src/rest/routers/*` and are mounted in `routers/index.ts`.
- OAuth routes are mounted first and are public; all other routes use protected middleware.

### Middleware flow (protected routes)
- `withDatabase` attaches a singleton DB instance as `c.get("db")`.
- `withAuth` accepts:
  - OAuth access tokens (`mid_access_token_*`) validated via DB and sets `session`, `teamId`, `scopes`.
  - API keys (`mid_*`) validated by format and hashed lookup; user and key are cached.
- Rate limiting via `hono-rate-limiter`, keyed by `session.user.id`.
- `withPrimaryReadAfterWrite`:
  - Mutations write a short-lived marker per team and force primary DB.
  - Subsequent reads on that team within the window also use primary.
- `withRequiredScope(...scopes)` enforces scope-based authorization.

### Request/response validation
- Use `c.req.valid("json" | "query" | "param")` to access already-validated input.
- Define request and response schemas in `apps/api/src/schemas/*` with Zod (using `.openapi()` where helpful).
- Always wrap responses with `validateResponse(data, schema)` before `c.json(...)` to guarantee contract fidelity.
- Prefer explicit `HTTPException(status, { message })` for error paths.

### Context variables available
- `db`: Drizzle DB client.
- `session`: `{ user: { id, email?, full_name? }, teamId? }`.
- `teamId`: Derived from OAuth token team or current team lookup.
- `scopes`: Expanded string array for `withRequiredScope`.

### Common patterns
- Pagination: `meta.cursor`, `hasPreviousPage`, `hasNextPage` plus `data: [...]`.
- Sorting: pass `sort` as a 2-tuple-like array when supported.
- Pre-signed URLs: create a Supabase admin client (`services/supabase`) and call `@midday/supabase/storage.signedUrl`. Return `{ url, expiresAt, fileName }`.

### TRPC notes
- Mounted under `/trpc/*` with `createTRPCContext` providing `session`, `db`, `supabase`, `geo`, and optional `teamId`.
- Internal middleware mirrors REST patterns: primary-read-after-write and team permission helpers.

### Health and ops
- `/health` basic check, `/health/db` DB timing and pool summary, `/health/pools` detailed pool stats.
- Fly.io: `fly.toml` and `fly-preview.yml` set `PORT=8080` and `internal_port = 8080`, health checks hit `/health`, autoscaling via machines.
- Docker: Bun base image, `turbo prune` for minimal context, multi-stage install. The app reads `PORT`; default dev port is 3003 (`package.json`).

### Adding a new REST endpoint
- Add Zod request and response schemas under `src/schemas`.
- In a router file:
  - Create an `OpenAPIHono<Context>()`.
  - Use `createRoute({...})` with `request`, `responses`, and `middleware: [withRequiredScope(...)]`.
  - Read input via `c.req.valid(...)`; get `db`, `teamId`, `session` via `c.get(...)`.
  - Call DB layer (`@midday/db/queries`).
  - Return `c.json(validateResponse(result, ResponseSchema))`.
- Mount the router in `rest/routers/index.ts` (after applying `protectedMiddleware` unless public).

### Style and safety
- Keep route names, tags, and operationIds consistent and descriptive.
- Serialize complex objects to strings when required by response contracts.
- Avoid leaking secrets; never echo tokens. Use caches for API keys and users.
