---
description: Midday Engine patterns and conventions (Cloudflare Workers + Hono + zod-openapi)
globs:
  - apps/engine/**
alwaysApply: true
---

## Midday Engine (Cloudflare Workers + Hono + zod-openapi)

### High-level
- Stateless Cloudflare Worker that brokers multiple data providers (Teller, Plaid, GoCardLess, EnableBanking) behind a single, typed REST surface.
- Routes are built with `OpenAPIHono` + `@hono/zod-openapi`; each resource folder contains its own `schema.ts` and `index.ts`.
- A provider facade (`src/providers/index.ts`) mediates all provider-specific logic via a common interface and per-provider implementations.
- External payloads are normalized via `transform.ts` into shared domain types defined in `src/providers/types.ts`.

### Runtime & bindings
- Prefer `env(c)` from `hono/adapter` to read runtime bindings, typed via `src/common/bindings.ts`.
- Bindings include:
  - `KV` (token/cache), `STORAGE` (R2 assets), `TELLER_CERT` (Fetcher for MTLS), `AI` (Workers AI), and provider/search secrets (`API_SECRET_KEY`, `PLAID_*`, `GOCARDLESS_*`, `TYPESENSE_*`, `ENABLEBANKING_*`).
- Local dev: `wrangler dev` (see `package.json`), secrets in `.dev.vars` (sample in `.dev.vars-example`).

### App entry & middleware
- Entry: `src/index.ts` creates `OpenAPIHono` with a `defaultHook` (422 on validation errors), installs middlewares, mounts routes, and redirects `/` to `https://midday.ai`.
- Middlewares (`src/middleware.ts`):
  - `authMiddleware`: bearer auth with `API_SECRET_KEY`. Public paths: `/`, `/openapi`, `/health`.
  - `securityMiddleware`: `secureHeaders()`.
  - `loggingMiddleware`: Hono logger wired to `src/utils/logger.ts`.

### Route shape & schema pattern
- Each route uses `app.openapi(createRoute(...), handler)` and returns `{ data: ... }` on success. Errors go through `createErrorResponse`.
- Inputs are read with `c.req.valid("query" | "json" | "param")` validated by `zod-openapi`.
- Resource routes:
  - `transactions/` — fetch transactions via provider facade
  - `accounts/` — list accounts, balances, delete (provider-dependent)
  - `connections/` — connection status/delete and GoCardLess utils
  - `institutions/` — Typesense-backed search + usage updates
  - `rates/` — currency rates from CDN
  - `health/` — aggregated provider + search health

### Provider facade & implementations
- Facade: `src/providers/index.ts` selects a provider and exposes a uniform API: `getTransactions`, `getAccounts`, `getAccountBalance`, `getInstitutions`, `getConnectionStatus`, `deleteConnection`, `deleteAccounts`, `getHealthCheck`.
- Per-provider folders: `src/providers/{teller,plaid,gocardless,enablebanking}` follow the same layout:
  - `*-api.ts` — HTTP/SDK client only (auth, pagination, caching, retries)
  - `*-provider.ts` — implements `src/providers/interface.ts`; composes API + transforms
  - `transform.ts` — converts provider payloads into Engine domain models
  - `types.ts` — provider-specific request/response types
  - `*.test.ts` + `__snapshots__` — Bun tests for deterministic transforms

### Data transformation conventions
- Amount sign normalization:
  - Teller: depends on `accountType` (credit flips sign).
  - Plaid: convert Plaid convention (positive outflow, negative inflow) to Engine sign.
  - GoCardLess/EnableBanking: map per API semantics; always uppercase currency.
- Names & descriptions: prefer `capitalCase`; derive name from merchant/creditor/debtor/remittance; avoid duplicating name in description.
- Method mapping: map to one of `payment`, `card_purchase`, `card_atm`, `transfer`, `ach`, `interest`, `deposit`, `wire`, `fee`, `other`.
- Categories: compact set (e.g., `income`, `fees`, `meals`, `travel`, `utilities`, `rent`, `software`, `marketing`, `equipment`, `professional-services-fees`, etc.). Use `null` if unknown.
- Account fields: `resource_id` (GoCardLess), `enrollment_id` (Teller), `expires_at` (EnableBanking/GoCardLess), logos via `getLogoURL`.

### Error handling
- Throw `ProviderError` with `{ message, code }`; coerces upstream error codes into canonical ones (notably `disconnected`).
- Handlers catch and return `createErrorResponse(error)` with HTTP 400 for provider failures.
- Each provider has an `isError(...)` helper to parse upstream responses.

### Search (Typesense) & rates
- Typesense client in `src/utils/search.ts` (multi-region nodes + `nearestNode`); health check used by `/health`.
- Rates in `src/utils/rates.ts`: fetch currency JSON, uppercase keys, filter by `uniqueCurrencies` from `@midday/location`.

### Caching, tokens, and auth details
- GoCardLess: access/refresh tokens + institutions cached in KV under namespaced keys; expire earlier than provider TTL by ~1h.
- EnableBanking: JWT RS256 built from base64 PKCS8 key content; `kid`=`application id`; randomizes `Psu-*` headers per request.

### Tasks & assets
- Bun task scripts in `apps/engine/tasks/*`:
  - `download-gocardless.ts`, `download-teller.ts` — mirror provider logos
  - `get-institutions.ts` — aggregate institutions across providers, normalize IDs (e.g., EnableBanking hash), attach logos/popularity
  - `import.ts` — upsert documents into Typesense
- Popularity heuristics: `tasks/utils.ts`.

### Health model
- Facade `getHealthCheck` probes Teller, Plaid, GoCardLess, EnableBanking in parallel; `/health` merges with Typesense health and returns 400 if any are unhealthy.

### Adding a new provider (checklist)
- Types: extend `Providers` in `src/common/schema.ts` and unions in `src/providers/types.ts`.
- Implementation: add `src/providers/<name>/{ <name>-api.ts, <name>-provider.ts, transform.ts, types.ts }` + tests; wire in `src/providers/index.ts`.
- Bindings: add required envs to `src/common/bindings.ts`, `.dev.vars-example`, and (if needed) `wrangler.toml`.
- Health: implement `getHealthCheck()`; add to facade aggregation.
- Institutions (optional): extend tasks to fetch catalogs/logos and Typesense import.

### Adding a new endpoint (checklist)
- Create `src/routes/<resource>/schema.ts` with `zod-openapi` request/response shapes.
- Create `src/routes/<resource>/index.ts` with `app.openapi(createRoute(...), handler)`.
- In handler: `const envs = env(c);` → read inputs via `c.req.valid(...)` → instantiate `new Provider({ provider, kv: c.env.KV, fetcher: c.env.TELLER_CERT, envs })` → call facade → return `{ data }` → map errors.
- Mount in `src/index.ts` via `.route("/<resource>", resourceRoutes)`.

### Common gotchas
- Use `env(c)` with typed `Bindings`; avoid `process.env` in runtime (tasks may use it).
- Keep transforms deterministic for tests (e.g., scrub dynamic dates before snapshot expectations).
- Uppercase currency codes and normalize amount signs consistently.
- Avoid pending transactions unless explicitly intended (Teller filters them by default).
- When caching in KV, prefer conservative TTLs to avoid expiry races.

### Key files
- Entrypoint & mount: `src/index.ts`
- Middlewares: `src/middleware.ts`
- Bindings & common schemas: `src/common/{bindings.ts,schema.ts}`
- Provider facade & types: `src/providers/{index.ts,interface.ts,types.ts}`
- Per-provider stacks: `src/providers/{teller,plaid,gocardless,enablebanking}/*`
- Routes: `src/routes/*/{schema.ts,index.ts}`
- Utilities: `src/utils/*` (error, logger, logo, paginate, rates, retry, search, account)
- Config: `wrangler.toml`, `package.json` scripts, `.dev.vars-example`
